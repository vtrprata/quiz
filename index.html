<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicativo de Questões</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.firebase = { initializeApp, getFirestore, collection, getDocs, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut };
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyC4EzFxpewwvx1snhDHyB5VZJXq29x58dk",
            authDomain: "perguntas-a04c3.firebaseapp.com",
            projectId: "perguntas-a04c3",
            storageBucket: "perguntas-a04c3.firebasestorage.app",
            messagingSenderId: "634470872272",
            appId: "1:634470872272:web:1bee0b0435b4c65eef9ad5"
        };

        const { useState, useEffect } = React;

        const App = () => {
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [correctCount, setCorrectCount] = useState(0);
            const [wrongCount, setWrongCount] = useState(0);
            const [feedback, setFeedback] = useState('');
            const [isAnswered, setIsAnswered] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const firestoreDb = window.firebase.getFirestore(app);
                        const firebaseAuth = window.firebase.getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        window.firebase.onAuthStateChanged(firebaseAuth, async (currentUser) => {
                            if (!currentUser) {
                                await window.firebase.signInAnonymously(firebaseAuth);
                            } else {
                                setUser(currentUser);
                                setIsAuthReady(true);
                            }
                        });
                    } catch (error) {
                        console.error("Erro ao inicializar o Firebase:", error);
                        setIsAuthReady(true);
                    }
                };
                initializeFirebase();
            }, []);

            useEffect(() => {
                const fetchQuestions = async () => {
                    if (isAuthReady && db && auth) {
                        setIsLoading(true);
                        try {
                            const questionsCollectionRef = window.firebase.collection(db, 'questions');
                            const querySnapshot = await window.firebase.getDocs(questionsCollectionRef);
                            const fetchedQuestions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (fetchedQuestions.length > 0) {
                                setQuestions(fetchedQuestions.sort(() => Math.random() - 0.5));
                            } else {
                                setQuestions([]);
                            }
                        } catch (error) {
                            console.error("Erro ao buscar perguntas:", error);
                        } finally {
                            setIsLoading(false);
                        }
                    }
                };
                fetchQuestions();
            }, [isAuthReady, db, auth]);

            const handleGoogleSignIn = async () => {
                const provider = new window.firebase.GoogleAuthProvider();
                try { await window.firebase.signInWithPopup(auth, provider); } catch (error) { console.error("Erro no login com Google:", error); }
            };

            const handleLogout = async () => {
                try { await window.firebase.signOut(auth); setUser(null); } catch (error) { console.error("Erro no logout:", error); }
            };

            const handleAnswer = (userAnswer) => {
                if (isAnswered) return;
                const currentQuestion = questions[currentQuestionIndex];
                const isCorrect = userAnswer.toLowerCase() === currentQuestion.respostaCorreta.toLowerCase();
                setIsAnswered(true);
                if (isCorrect) { setCorrectCount(p => p + 1); setFeedback('Correto!'); }
                else { setWrongCount(p => p + 1); setFeedback('Errado!'); }
                setTimeout(() => { setFeedback(''); setIsAnswered(false); setCurrentQuestionIndex(p => p + 1); }, 1500);
            };

            const handleRestart = () => {
                setCorrectCount(0); setWrongCount(0); setCurrentQuestionIndex(0);
                setQuestions([...questions].sort(() => Math.random() - 0.5));
                setFeedback('');
            };

            if (isLoading || !isAuthReady) {
                return <div className="flex flex-col items-center justify-center min-h-screen"><h1 className="text-3xl font-bold animate-pulse">Carregando perguntas...</h1></div>;
            }

            if (questions.length === 0) {
                return <div className="flex flex-col items-center justify-center min-h-screen text-center"><h1 className="text-3xl font-bold mb-4">Nenhuma pergunta encontrada.</h1><p className="text-gray-600">Cadastre perguntas na coleção `questions` do Firestore.</p></div>;
            }

            if (currentQuestionIndex >= questions.length) {
                return <div className="flex flex-col items-center justify-center min-h-screen text-center"><div className="bg-white p-8 rounded-2xl shadow-xl"><h1 className="text-4xl font-extrabold text-blue-600 mb-4">Quiz Finalizado!</h1><p className="text-2xl text-green-600">Acertos: {correctCount}</p><p className="text-2xl text-red-600 mb-6">Erros: {wrongCount}</p><button onClick={handleRestart} className="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl">Reiniciar</button></div></div>;
            }

            const currentQuestion = questions[currentQuestionIndex];

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl">
                        <div className="w-full text-right mb-4">
                            {user && user.isAnonymous === false ? (
                                <div className="flex items-center justify-end space-x-2">
                                    <span className="text-gray-700">Olá, {user.displayName || 'Usuário'}!</span>
                                    <button onClick={handleLogout} className="py-1 px-3 bg-gray-200 rounded-lg">Sair</button>
                                </div>
                            ) : (
                                <button onClick={handleGoogleSignIn} className="px-4 py-2 bg-blue-500 text-white rounded-xl">Login com Google</button>
                            )}
                        </div>

                        <h1 className="text-3xl font-bold text-blue-600 mb-6">Aplicativo de Questões</h1>

                        <div className="mb-8">
                            <div className="bg-gray-50 p-6 rounded-xl border mb-4"><p className="text-sm font-semibold">Banca:</p><p className="text-lg font-bold">{currentQuestion?.banca || 'N/A'}</p></div>
                            <div className="bg-gray-50 p-6 rounded-xl border"><p className="text-sm font-semibold">Questão:</p><p className="text-xl">{currentQuestion?.questao || 'N/A'}</p></div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <button onClick={() => handleAnswer('Certo')} disabled={isAnswered} className={`py-4 rounded-xl text-white font-bold ${isAnswered ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'}`}>Certo</button>
                            <button onClick={() => handleAnswer('Errado')} disabled={isAnswered} className={`py-4 rounded-xl text-white font-bold ${isAnswered ? 'bg-gray-400' : 'bg-red-500 hover:bg-red-600'}`}>Errado</button>
                        </div>

                        {feedback && <p className={`text-xl font-bold mb-4 ${feedback === 'Correto!' ? 'text-green-600' : 'text-red-600'}`}>{feedback}</p>}

                        <div className="text-center mb-6">
                            <p className="text-sm font-semibold mb-2">Sessão Atual:</p>
                            <div className="flex justify-around bg-gray-50 p-4 rounded-xl">
                                <div><span className="text-2xl font-bold text-green-600">{correctCount}</span><p className="text-xs">Acertos</p></div>
                                <div><span className="text-2xl font-bold text-red-600">{wrongCount}</span><p className="text-xs">Erros</p></div>
                            </div>
                        </div>

                        <button onClick={handleRestart} className="w-full px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl">Reiniciar</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
